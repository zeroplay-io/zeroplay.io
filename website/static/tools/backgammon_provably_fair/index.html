<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Fairness Verifier</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<style>
		:root {
			--bg: #ffffff;
			--panel: #f5f5f5;
			--txt: #222222;
			--accent: #3dcf8f;
			--err: #ff5555;
			--font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
		}

		* {
			box-sizing: border-box;
			font-family: var(--font);
			margin: 0;
			padding: 0;
		}

		body {
			background: var(--bg);
			color: var(--txt);
			display: flex;
			justify-content: center;
			align-items: flex-start;
			min-height: 100vh;
			padding: 24px;
		}

		#wrapper {
			width: 100%;
			max-width: 720px;
			background: var(--panel);
			border-radius: 12px;
			padding: 24px;
			box-shadow: 0 4px 18px rgba(0, 0, 0, .08);
		}

		h1 {
			font-size: 1.4rem;
			margin-bottom: 12px;
			text-align: center;
		}

		textarea {
			width: 100%;
			min-height: 200px;
			background: #fff;
			border: 1px solid #ccc;
			color: var(--txt);
			font: 14px/1.4 monospace;
			padding: 12px;
			border-radius: 8px;
			resize: vertical;
		}

		button {
			margin-top: 16px;
			width: 100%;
			padding: 12px 0;
			font-size: 1rem;
			font-weight: 600;
			background: var(--accent);
			color: #fff;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			transition: filter .15s;
		}

		button:hover {
			filter: brightness(1.1);
		}

		pre {
			margin-top: 16px;
			white-space: pre-wrap;
			word-break: break-all;
			background: #fafafa;
			color: var(--txt);
			padding: 12px;
			border-radius: 8px;
			min-height: 2.2em;
		}

		.bad {
			color: var(--err);
		}

		.good {
			color: var(--accent);
		}

		footer {
			margin-top: 24px;
			font-size: .8rem;
			text-align: center;
			opacity: .8;
		}

		a {
			color: var(--accent);
			text-decoration: none;
		}

		a:hover {
			filter: brightness(1.15);
		}

	</style>

</head>

<body>
	<div id="wrapper">
		<textarea id="input" placeholder="Copy or drag report file to here"></textarea>
		<pre id="out"></pre>
		<button id="btn">Verify</button>

		<footer>Offline Running · Provably Fair · <a href="https://github.com/gopherd/backgammon_provably_fair"
				target="_blank" rel="noopener"><strong>Open Source</strong></a></footer>
	</div>

	<script src="wasm_exec.js"></script>
	<script>
		/* ------- Go → WASM runtime bootstrap ------- */
		const go = new Go();
		let wasmReady = false;

		WebAssembly.instantiateStreaming(fetch("verifier.wasm"), go.importObject)
			.then(r => {
				go.run(r.instance);     // verify() 会被导出到全局
				wasmReady = true;       // 标记：verify 已可用
				maybeAutoVerify();      // 若有 report 参数，立刻执行
			});

		/* ------- UI helpers ------- */
		const $ = id => document.getElementById(id);
		$("btn").onclick = run;

		$("input").addEventListener("dragover", e => e.preventDefault());
		$("input").addEventListener("drop", e => {
			e.preventDefault();
			if (!e.dataTransfer.files.length) return;
			e.dataTransfer.files[0].text().then(t => {$("input").value = t;});
		});

		/* ------- 核心函数 ------- */
		function run() {
			$("out").textContent = "Verifying…";
			try {
				const res = verify($("input").value);
				$("out").className = (res === "OK" ? "good" : "bad");
				$("out").textContent = (res === "OK" ? "✅ VERIFIED" : "❌ " + res);
			} catch (err) {
				$("out").className = "bad";
				$("out").textContent = "Error: " + err;
			}
		}

		/* ------- 自动解析 ?report=BASE64 ------- */
		function maybeAutoVerify() {
			const p = new URLSearchParams(window.location.search);
			if (!p.has("report")) return;

			try {
				// 先 URL 解码，再把 URL-safe Base64 转回标准形式
				const b64 = decodeURIComponent(p.get("report"))
					.replace(/-/g, "+").replace(/_/g, "/");
				const decoded = atob(b64);          // Base64 → binary string
				const text = new TextDecoder().decode(
					Uint8Array.from(decoded, c => c.charCodeAt(0))); // UTF-8

				$("input").value = text;

				const doVerify = () => {
					run();
					// --- 滚动到底部 ---
					window.scrollTo({
						top: document.body.scrollHeight,
						behavior: "smooth"   // 想要瞬间跳转就去掉这一行
					});
				};

				// 如果 WASM 还没就绪，轮询等待
				if (!wasmReady) {
					const h = setInterval(() => {
						if (wasmReady) {clearInterval(h); doVerify();}
					}, 40);
				} else {
					doVerify();
				}
			} catch (e) {
				console.error("Failed to decode report param:", e);
			}
		}
	</script>

</body>

</html>
