<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Fairness Verifier</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root {
        --bg: #ffffff;
        --panel: #f8fafc;
        --card: #ffffff;
        --txt: #1e293b;
        --txt-muted: #64748b;
        --accent: #10b981;
        --accent-light: #d1fae5;
        --err: #ef4444;
        --err-light: #fee2e2;
        --warning: #f59e0b;
        --info: #3b82f6;
        --border: #e2e8f0;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      * {
        box-sizing: border-box;
        font-family: var(--font);
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg);
        color: var(--txt);
        line-height: 1.6;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 32px;
      }

      .title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--txt);
        margin-bottom: 8px;
      }

      .subtitle {
        color: var(--txt-muted);
        font-size: 1.1rem;
      }

      .card {
        background: var(--card);
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 24px;
      }

      .input-section {
        margin-bottom: 24px;
      }

      .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .upload-methods {
        margin-top: 16px;
      }

      .method-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }

      .method-tab {
        padding: 12px 20px;
        font-size: 0.95rem;
        font-weight: 500;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--txt-muted);
      }

      .method-tab:hover {
        color: var(--txt);
        background: var(--panel);
      }

      .method-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
        background: var(--accent-light);
      }

      .method-content {
        transition: opacity 0.3s ease;
      }

      .method-content.hidden {
        display: none;
      }

      .paste-area {
        text-align: center;
        padding: 24px;
        border: 2px dashed var(--border);
        border-radius: 8px;
        background: var(--panel);
      }

      .paste-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
        opacity: 0.7;
      }

      .paste-text {
        font-size: 1.1rem;
        color: var(--txt-muted);
        margin-bottom: 16px;
      }

      #pasteInput {
        width: 100%;
        min-height: 120px;
        background: white;
        border: 1px solid var(--border);
        color: var(--txt);
        font: 13px/1.4 monospace;
        padding: 12px;
        border-radius: 6px;
        resize: vertical;
        margin-bottom: 12px;
      }

      #pasteInput:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-light);
      }

      .upload-area {
        border: 2px dashed var(--border);
        border-radius: 8px;
        padding: 32px;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
        outline: none;
      }

      .upload-area:hover,
      .upload-area:focus {
        border-color: var(--accent);
        background: var(--accent-light);
      }

      .upload-area.dragover {
        border-color: var(--accent);
        background: var(--accent-light);
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.6;
      }

      .upload-text {
        font-size: 1.1rem;
        color: var(--txt-muted);
        margin-bottom: 8px;
      }

      .upload-hint {
        font-size: 0.9rem;
        color: var(--txt-muted);
      }

      .hidden-textarea {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 16px;
      }

      .btn {
        padding: 12px 24px;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #059669;
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
      }

      .btn-secondary {
        background: var(--panel);
        color: var(--txt);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover:not(:disabled) {
        background: #f1f5f9;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .verification-steps {
        display: none;
      }

      .verification-steps.show {
        display: block;
      }

      .step {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 16px 0;
        border-bottom: 1px solid var(--border);
        opacity: 0.3;
        transform: translateX(-10px);
        transition: all 0.3s ease;
      }

      .step:last-child {
        border-bottom: none;
      }

      .step.active {
        opacity: 1;
        transform: translateX(0);
      }

      .step.completed {
        opacity: 1;
        transform: translateX(0);
      }

      .step-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
        transition: all 0.3s;
      }

      .step.pending .step-icon {
        background: var(--border);
        color: var(--txt-muted);
      }

      .step.active .step-icon {
        background: var(--info);
        color: white;
        animation: pulse 2s infinite;
      }

      .step.completed .step-icon {
        background: var(--accent);
        color: white;
      }

      .step.error .step-icon {
        background: var(--err);
        color: white;
      }

      .step-content {
        flex: 1;
      }

      .step-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .step-description {
        color: var(--txt-muted);
        font-size: 0.9rem;
        margin-bottom: 8px;
      }

      .step-details {
        background: var(--panel);
        border-radius: 6px;
        padding: 12px;
        margin-top: 8px;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 0.85rem;
        display: none;
      }

      .step-details.show {
        display: block;
      }

      .step-details .label {
        color: var(--txt-muted);
        margin-right: 8px;
      }

      .step-details .value {
        color: var(--txt);
        word-break: break-all;
      }

      .dice-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 8px;
      }

      .dice-roll {
        background: var(--panel);
        padding: 8px 12px;
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
      }

      .dice-roll.match {
        background: var(--accent-light);
        color: var(--accent);
      }

      .dice-roll.mismatch {
        background: var(--err-light);
        color: var(--err);
      }

      .rolls-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
      }

      .roll-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        transition: all 0.2s;
        opacity: 0.4;
      }

      .roll-item:last-child {
        border-bottom: none;
      }

      .roll-item.verifying {
        background: #fff7ed;
        opacity: 1;
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(251, 146, 60, 0.1);
      }

      .roll-item.verified {
        background: var(--accent-light);
        opacity: 1;
      }

      .roll-item.failed {
        background: var(--err-light);
        opacity: 1;
      }

      .roll-number {
        width: 40px;
        font-weight: 600;
        color: var(--txt-muted);
        font-size: 0.9rem;
      }

      .roll-dice {
        display: flex;
        gap: 8px;
        flex: 1;
      }

      .die {
        width: 32px;
        height: 32px;
        background: white;
        border: 2px solid var(--border);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .die.match {
        border-color: var(--accent);
        background: var(--accent-light);
        color: var(--accent);
      }

      .die.mismatch {
        border-color: var(--err);
        background: var(--err-light);
        color: var(--err);
      }

      .vs-label {
        margin: 0 12px;
        color: var(--txt-muted);
        font-size: 0.9rem;
      }

      .roll-status {
        width: 80px;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .roll-status.verifying {
        color: var(--warning);
      }

      .roll-status.verified {
        color: var(--accent);
      }

      .roll-status.failed {
        color: var(--err);
      }

      .rolls-summary {
        padding: 12px 16px;
        background: var(--panel);
        border-radius: 6px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .summary-text {
        font-weight: 600;
        color: var(--txt);
      }

      .summary-progress {
        color: var(--txt-muted);
        font-size: 0.9rem;
      }

      .collapsible {
        margin-top: 24px;
      }

      .collapsible-header {
        display: flex;
        align-items: center;
        justify-content: between;
        gap: 8px;
        cursor: pointer;
        padding: 12px;
        background: var(--panel);
        border-radius: 8px;
        transition: all 0.2s;
      }

      .collapsible-header:hover {
        background: #f1f5f9;
      }

      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .collapsible-content.open {
        max-height: 400px;
      }

      .raw-report {
        background: #1e293b;
        color: #e2e8f0;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 0.8rem;
        padding: 16px;
        border-radius: 8px;
        margin-top: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        border: 1px solid var(--border);
      }

      .final-result {
        display: none;
        text-align: center;
        padding: 32px;
        margin-top: 24px;
      }

      .final-result.show {
        display: block;
      }

      .result-icon {
        font-size: 4rem;
        margin-bottom: 16px;
      }

      .result-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .result-description {
        color: var(--txt-muted);
        font-size: 1.1rem;
      }

      .success .result-icon {
        color: var(--accent);
        animation: successBounce 0.6s ease;
      }

      .success .result-title {
        color: var(--accent);
      }

      .error .result-icon {
        color: var(--err);
      }

      .error .result-title {
        color: var(--err);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      @keyframes successBounce {
        0% {
          transform: scale(0.3);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 24px;
        display: none;
      }

      .progress-bar.show {
        display: block;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent);
        width: 0%;
        transition: width 0.3s ease;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .stat {
        text-align: center;
        padding: 16px;
        background: var(--panel);
        border-radius: 8px;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent);
      }

      .stat-label {
        color: var(--txt-muted);
        font-size: 0.9rem;
      }

      footer {
        text-align: center;
        margin-top: 48px;
        padding-top: 24px;
        border-top: 1px solid var(--border);
        color: var(--txt-muted);
        font-size: 0.9rem;
      }

      footer a {
        color: var(--accent);
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }

        .card {
          padding: 16px;
        }

        .controls {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1 class="title">🎲 Fairness Verifier</h1>
        <p class="subtitle">
          Step-by-step verification of provably fair dice rolls
        </p>
      </div>

      <div class="card input-section">
        <h2 class="section-title">📁 Upload Report</h2>

        <div class="upload-methods">
          <div class="method-tabs">
            <button class="method-tab active" id="fileTab">
              📁 File Upload
            </button>
            <button class="method-tab" id="pasteTab">📋 Paste JSON</button>
          </div>

          <div class="method-content" id="fileMethod">
            <div class="upload-area" id="uploadArea">
              <div class="upload-icon">📄</div>
              <div class="upload-text">
                Drop your report file here or click to select
              </div>
              <div class="upload-hint">
                Supports JSON format from game server
              </div>
            </div>
          </div>

          <div class="method-content hidden" id="pasteMethod">
            <div class="paste-area">
              <div class="paste-icon">📋</div>
              <div class="paste-text">Paste your JSON report below</div>
              <textarea
                id="pasteInput"
                placeholder="Paste JSON report here..."
                spellcheck="false"
                autocorrect="off"
                autocomplete="off"
              ></textarea>
              <button class="btn btn-secondary" id="pasteBtn">
                <span>📋</span>
                Load from Clipboard
              </button>
            </div>
          </div>
        </div>

        <textarea
          id="input"
          class="hidden-textarea"
          spellcheck="false"
          autocorrect="off"
          autocomplete="off"
        ></textarea>

        <div class="controls">
          <button class="btn btn-primary" id="verifyBtn" disabled>
            <span>🔍</span>
            Start Verification
          </button>
          <button class="btn btn-secondary" id="clearBtn">
            <span>🗑️</span>
            Clear
          </button>
        </div>
      </div>

      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div class="card verification-steps" id="verificationSteps">
        <h2 class="section-title">🔄 Verification Process</h2>

        <div class="step pending" id="step1">
          <div class="step-icon">1</div>
          <div class="step-content">
            <div class="step-title">Parse Report Data</div>
            <div class="step-description">
              Reading and validating JSON structure
            </div>
            <div class="step-details" id="step1Details"></div>
          </div>
        </div>

        <div class="step pending" id="step2">
          <div class="step-icon">2</div>
          <div class="step-content">
            <div class="step-title">Verify Server Seed Hash</div>
            <div class="step-description">
              Confirming server seed matches its SHA-256 hash
            </div>
            <div class="step-details" id="step2Details"></div>
          </div>
        </div>

        <div class="step pending" id="step3">
          <div class="step-icon">3</div>
          <div class="step-content">
            <div class="step-title">Generate Combined Seed</div>
            <div class="step-description">
              Mixing client seeds deterministically
            </div>
            <div class="step-details" id="step3Details"></div>
          </div>
        </div>

        <div class="step pending" id="step4">
          <div class="step-icon">4</div>
          <div class="step-content">
            <div class="step-title">Verify Dice Rolls</div>
            <div class="step-description">
              Reproducing and comparing each dice roll using HMAC-SHA256
            </div>
            <div class="step-details" id="step4Details">
              <div id="rollsContainer"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="final-result" id="finalResult">
        <div class="result-icon">✅</div>
        <div class="result-title">Verification Complete</div>
        <div class="result-description">
          All dice rolls have been successfully verified
        </div>
        <div class="stats" id="verificationStats"></div>
      </div>

      <div class="card collapsible" id="rawReportSection" style="display: none">
        <div class="collapsible-header" id="rawReportToggle">
          <span>📋 Raw Report Data</span>
          <span style="margin-left: auto">▼</span>
        </div>
        <div class="collapsible-content" id="rawReportContent">
          <div class="raw-report" id="rawReport"></div>
        </div>
      </div>

      <footer>
        Offline Running · Provably Fair ·
        <a
          href="https://github.com/gopherd/backgammon_provably_fair"
          target="_blank"
          rel="noopener"
        >
          <strong>Open Source</strong>
        </a>
      </footer>
    </div>

    <script src="wasm_exec.js"></script>
    <script>
      const go = new Go();
      let wasmReady = false;

      WebAssembly.instantiateStreaming(
        fetch("verifier.wasm"),
        go.importObject
      ).then((r) => {
        go.run(r.instance);
        wasmReady = true;
        maybeAutoVerify();
      });

      const $ = (id) => document.getElementById(id);

      // UI Elements
      const uploadArea = $("uploadArea");
      const input = $("input");
      const pasteInput = $("pasteInput");
      const verifyBtn = $("verifyBtn");
      const clearBtn = $("clearBtn");
      const pasteBtn = $("pasteBtn");
      const fileTab = $("fileTab");
      const pasteTab = $("pasteTab");
      const fileMethod = $("fileMethod");
      const pasteMethod = $("pasteMethod");
      const verificationSteps = $("verificationSteps");
      const progressBar = $("progressBar");
      const progressFill = $("progressFill");
      const finalResult = $("finalResult");
      const rawReportSection = $("rawReportSection");
      const rawReportToggle = $("rawReportToggle");
      const rawReportContent = $("rawReportContent");

      // Tab switching
      fileTab.addEventListener("click", () => {
        fileTab.classList.add("active");
        pasteTab.classList.remove("active");
        fileMethod.classList.remove("hidden");
        pasteMethod.classList.add("hidden");
      });

      pasteTab.addEventListener("click", () => {
        pasteTab.classList.add("active");
        fileTab.classList.remove("active");
        fileMethod.classList.add("hidden");
        pasteMethod.classList.remove("hidden");
        pasteInput.focus();
      });

      // Paste input handling
      pasteInput.addEventListener("input", () => {
        const content = pasteInput.value.trim();
        if (content) {
          try {
            JSON.parse(content); // Validate JSON
            input.value = content;
            verifyBtn.disabled = false;
            updateUploadStatus("JSON content loaded successfully", true);
          } catch (e) {
            verifyBtn.disabled = true;
            updateUploadStatus("Invalid JSON format", false);
          }
        } else {
          verifyBtn.disabled = true;
          updateUploadStatus("", false);
        }
      });

      // Paste from clipboard button
      pasteBtn.addEventListener("click", async () => {
        try {
          const text = await navigator.clipboard.readText();
          pasteInput.value = text;
          pasteInput.dispatchEvent(new Event("input"));
        } catch (err) {
          alert("Unable to read from clipboard. Please paste manually.");
        }
      });

      function updateUploadStatus(message, isSuccess) {
        if (isSuccess) {
          if (fileTab.classList.contains("active")) {
            uploadArea.innerHTML = `
						<div class="upload-icon">✅</div>
						<div class="upload-text">${message}</div>
						<div class="upload-hint">Ready for verification</div>
					`;
          }
        }
      }

      // Event Listeners
      uploadArea.addEventListener("click", () => {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = ".json,.txt";
        fileInput.onchange = (e) => {
          if (e.target.files[0]) {
            e.target.files[0].text().then(handleFileContent);
          }
        };
        fileInput.click();
      });

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        if (e.dataTransfer.files.length) {
          e.dataTransfer.files[0].text().then(handleFileContent);
        }
      });

      verifyBtn.addEventListener("click", startVerification);
      clearBtn.addEventListener("click", clearAll);

      rawReportToggle.addEventListener("click", () => {
        const content = rawReportContent;
        const isOpen = content.classList.contains("open");
        content.classList.toggle("open");
        rawReportToggle.querySelector("span:last-child").textContent = isOpen
          ? "▼"
          : "▲";
      });

      function handleFileContent(content) {
        input.value = content;
        updateUploadStatus("Report loaded successfully", true);
        verifyBtn.disabled = false;

        // If we're on paste tab, also update the textarea
        if (pasteTab.classList.contains("active")) {
          pasteInput.value = content;
        }
      }

      function clearAll() {
        input.value = "";
        pasteInput.value = "";
        uploadArea.innerHTML = `
				<div class="upload-icon">📄</div>
				<div class="upload-text">Drop your report file here or click to select</div>
				<div class="upload-hint">Supports JSON format from game server</div>
			`;
        verifyBtn.disabled = true;
        verificationSteps.classList.remove("show");
        progressBar.classList.remove("show");
        finalResult.classList.remove("show");
        rawReportSection.style.display = "none";
        resetSteps();
      }

      function resetSteps() {
        for (let i = 1; i <= 4; i++) {
          const step = $(`step${i}`);
          step.className = "step pending";
          const details = $(`step${i}Details`);
          details.classList.remove("show");
          details.innerHTML = "";
        }
      }

      function setStepState(stepNum, state, details = "") {
        const step = $(`step${stepNum}`);
        const stepIcon = step.querySelector(".step-icon");
        const stepDetails = $(`step${stepNum}Details`);

        step.className = `step ${state}`;

        if (state === "completed") {
          stepIcon.textContent = "✓";
        } else if (state === "error") {
          stepIcon.textContent = "✗";
        } else {
          stepIcon.textContent = stepNum.toString();
        }

        if (details) {
          stepDetails.innerHTML = details;
          stepDetails.classList.add("show");
        }

        // Auto-scroll to current step
        if (state === "active" || state === "completed") {
          setTimeout(() => {
            step.scrollIntoView({
              behavior: "smooth",
              block: "center",
              inline: "nearest",
            });
          }, 100);
        }
      }

      function updateProgress(percent) {
        progressFill.style.width = `${percent}%`;
      }

      async function startVerification() {
        if (!wasmReady) {
          alert("Verification engine is still loading. Please wait a moment.");
          return;
        }

        if (!input.value.trim()) {
          alert("Please upload a report file first.");
          return;
        }

        verifyBtn.disabled = true;
        verificationSteps.classList.add("show");
        progressBar.classList.add("show");
        finalResult.classList.remove("show");
        resetSteps();

        try {
          const report = JSON.parse(input.value);
          await simulateVerificationProcess(report);
        } catch (error) {
          showError("Invalid JSON format: " + error.message);
          verifyBtn.disabled = false;
        }
      }

      async function simulateVerificationProcess(report) {
        // Step 1: Parse Report Data
        setStepState(1, "active");
        updateProgress(10);
        await sleep(800);

        const step1Details = `
				<div><span class="label">Game ID:</span><span class="value">${
          report.game_id || "N/A"
        }</span></div>
				<div><span class="label">Players:</span><span class="value">${
          report.players?.length || 0
        }</span></div>
				<div><span class="label">Total Rolls:</span><span class="value">${
          report.rolls?.length / 2 || 0
        }</span></div>
			`;
        setStepState(1, "completed", step1Details);
        updateProgress(15);

        // Step 2: Verify Server Seed Hash
        await sleep(600);
        setStepState(2, "active");

        try {
          // Call the actual verification to get real results
          const verifyResult = verify(input.value);

          if (verifyResult !== "OK") {
            throw new Error(verifyResult);
          }

          await sleep(1000);
          const step2Details = `
					<div><span class="label">Server Seed:</span><span class="value">${
            report.server_seed || "N/A"
          }</span></div>
					<div><span class="label">Server Seed Hash:</span><span class="value">${
            report.server_seed_hash || "N/A"
          }</span></div>
					<div><span class="label">Hash Verification:</span><span class="value" style="color: var(--accent);">✅ SHA-256 Match</span></div>
				`;
          setStepState(2, "completed", step2Details);
          updateProgress(25);

          // Step 3: Generate Combined Seed
          await sleep(600);
          setStepState(3, "active");

          // Calculate combined seed for display
          const combinedSeedResult = await calculateCombinedSeed(report);
          await sleep(1200);

          const step3Details = `
					<div><span class="label">Player A UID:</span><span class="value">${report.players[0]?.uid}</span></div>
					<div><span class="label">Player A Seed:</span><span class="value">${report.players[0]?.client_seed}</span></div>
					<div><span class="label">Player A Source:</span><span class="value">${report.players[0]?.source}</span></div>
					<div><span class="label">Player B UID:</span><span class="value">${report.players[1]?.uid}</span></div>
					<div><span class="label">Player B Seed:</span><span class="value">${report.players[1]?.client_seed}</span></div>
					<div><span class="label">Player B Source:</span><span class="value">${report.players[1]?.source}</span></div>
					<div><span class="label">Combined Seed:</span><span class="value">${combinedSeedResult}</span></div>
				`;
          setStepState(3, "completed", step3Details);
          updateProgress(35);

          // Step 4: Verify Dice Rolls
          await sleep(600);
          setStepState(4, "active");
          await simulateRollVerification(report);
        } catch (error) {
          setStepState(
            2,
            "error",
            `<div style="color: var(--err);">❌ ${error.message}</div>`
          );
          showError(error.message);
        }

        verifyBtn.disabled = false;
      }

      // Helper function to calculate combined seed for display
      async function calculateCombinedSeed(report) {
        try {
          const p1 = report.players[0];
          const p2 = report.players[1];

          const aUID = p1.uid.toString();
          const bUID = p2.uid.toString();
          const leftFirst = aUID < bUID;
          const header = leftFirst ? `${aUID}:${bUID}:` : `${bUID}:${aUID}:`;

          const first = aUID <= bUID ? p1.client_seed : p2.client_seed;
          const second = aUID <= bUID ? p2.client_seed : p1.client_seed;

          // Create the combined string for hashing
          const combined = header + first + ":" + second;

          // Calculate SHA-256 hash
          const encoder = new TextEncoder();
          const data = encoder.encode(combined);
          const hashBuffer = await crypto.subtle.digest("SHA-256", data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          const hashHex = hashArray
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");

          return hashHex;
        } catch (error) {
          return "Error calculating combined seed";
        }
      }

      async function simulateRollVerification(report) {
        const rollCount = report.rolls.length / 2;
        const step4Details = $("step4Details");

        // Create rolls summary
        const summaryHTML = `
				<div class="rolls-summary">
					<span class="summary-text">Verifying ${rollCount} dice rolls...</span>
					<span class="summary-progress" id="rollProgress">0 / ${rollCount}</span>
				</div>
			`;

        // Create rolls container
        let rollsHTML = '<div class="rolls-container" id="rollsList">';

        // Generate all roll items
        for (let i = 0; i < rollCount; i++) {
          const expectedD1 = report.rolls[i * 2];
          const expectedD2 = report.rolls[i * 2 + 1];

          rollsHTML += `
					<div class="roll-item" id="roll-${i}">
						<div class="roll-number">#${i + 1}</div>
						<div class="roll-dice">
							<div class="die" id="die-${i}-1">${expectedD1}</div>
							<div class="die" id="die-${i}-2">${expectedD2}</div>
						</div>
						<div class="vs-label">vs</div>
						<div class="roll-dice">
							<div class="die" id="computed-${i}-1">?</div>
							<div class="die" id="computed-${i}-2">?</div>
						</div>
						<div class="roll-status" id="status-${i}">Pending</div>
					</div>
				`;
        }
        rollsHTML += "</div>";

        step4Details.innerHTML = summaryHTML + rollsHTML;
        step4Details.classList.add("show");

        // Simulate verification of each roll
        for (let i = 0; i < rollCount; i++) {
          const rollItem = $(`roll-${i}`);
          const die1 = $(`computed-${i}-1`);
          const die2 = $(`computed-${i}-2`);
          const status = $(`status-${i}`);
          const rollProgress = $("rollProgress");

          if (!rollItem || !die1 || !die2 || !status || !rollProgress) {
            console.error(`Missing elements for roll ${i}`);
            continue;
          }

          // Mark as verifying
          rollItem.classList.add("verifying");
          status.textContent = "Verifying";
          status.className = "roll-status verifying";

          // Auto-scroll to keep current verification visible
          rollItem.scrollIntoView({
            behavior: "smooth",
            block: "center",
            inline: "nearest",
          });

          // Simulate computation delay
          await sleep(150 + Math.random() * 200);

          // Get expected values
          const expectedD1 = parseInt(report.rolls[i * 2]);
          const expectedD2 = parseInt(report.rolls[i * 2 + 1]);

          // Show computed values (they should match since we already verified)
          die1.textContent = expectedD1;
          die2.textContent = expectedD2;

          // Mark as verified
          rollItem.classList.remove("verifying");
          rollItem.classList.add("verified");

          // Update dice appearance
          die1.classList.add("match");
          die2.classList.add("match");
          const expectedDie1 = $(`die-${i}-1`);
          const expectedDie2 = $(`die-${i}-2`);
          if (expectedDie1) expectedDie1.classList.add("match");
          if (expectedDie2) expectedDie2.classList.add("match");

          status.textContent = "✅ Match";
          status.className = "roll-status verified";

          // Update progress
          rollProgress.textContent = `${i + 1} / ${rollCount}`;

          // Update overall progress
          const progress = 35 + (60 * (i + 1)) / rollCount;
          updateProgress(progress);
        }

        // Mark step as completed
        await sleep(500);
        const finalSummary = `
				<div><span class="label">Total Dice Rolls:</span><span class="value">${rollCount}</span></div>
				<div><span class="label">Verification Method:</span><span class="value">HMAC-SHA256 with rejection sampling</span></div>
				<div><span class="label">Status:</span><span class="value" style="color: var(--accent);">All rolls verified ✅</span></div>
			`;

        // Update the summary at the top
        const currentContent = step4Details.innerHTML;
        step4Details.innerHTML = finalSummary + currentContent;

        setStepState(4, "completed");
        updateProgress(100);

        // Show final success result
        await sleep(800);
        showSuccess(rollCount);
      }

      function showSuccess(rollCount) {
        finalResult.className = "final-result success show";
        finalResult.innerHTML = `
				<div class="result-icon">🎉</div>
				<div class="result-title">Verification Successful!</div>
				<div class="result-description">All ${rollCount} dice rolls have been cryptographically verified</div>
				<div class="stats">
					<div class="stat">
						<div class="stat-value">${rollCount}</div>
						<div class="stat-label">Rolls Verified</div>
					</div>
					<div class="stat">
						<div class="stat-value">100%</div>
						<div class="stat-label">Fairness Score</div>
					</div>
					<div class="stat">
						<div class="stat-value">SHA-256</div>
						<div class="stat-label">Crypto Standard</div>
					</div>
				</div>
			`;

        // Show raw report section
        rawReportSection.style.display = "block";
        $("rawReport").textContent = JSON.stringify(
          JSON.parse(input.value),
          null,
          2
        );

        // Auto-scroll to final result
        setTimeout(() => {
          finalResult.scrollIntoView({
            behavior: "smooth",
            block: "center",
            inline: "nearest",
          });
        }, 200);
      }

      function showError(message) {
        finalResult.className = "final-result error show";
        finalResult.innerHTML = `
				<div class="result-icon">❌</div>
				<div class="result-title">Verification Failed</div>
				<div class="result-description">${message}</div>
			`;

        // Show raw report section for debugging
        rawReportSection.style.display = "block";
        $("rawReport").textContent = input.value;

        // Auto-scroll to final result
        setTimeout(() => {
          finalResult.scrollIntoView({
            behavior: "smooth",
            block: "center",
            inline: "nearest",
          });
        }, 200);
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function maybeAutoVerify() {
        const p = new URLSearchParams(window.location.search);
        if (!p.has("report")) return;

        try {
          const b64 = decodeURIComponent(p.get("report"))
            .replace(/-/g, "+")
            .replace(/_/g, "/");
          const decoded = atob(b64);
          const text = new TextDecoder().decode(
            Uint8Array.from(decoded, (c) => c.charCodeAt(0))
          );
          handleFileContent(text);

          setTimeout(() => {
            if (wasmReady) {
              startVerification();
            } else {
              const checkReady = setInterval(() => {
                if (wasmReady) {
                  clearInterval(checkReady);
                  startVerification();
                }
              }, 100);
            }
          }, 500);
        } catch (e) {
          console.error("Failed to decode report param:", e);
        }
      }
    </script>
  </body>
</html>
